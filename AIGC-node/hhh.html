<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button id="connect">链接</button>
    <button id="send">发送</button>
    <span id="recv"></span>
    <div id="output"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script>
      const outputDiv = document.getElementById("output");
      async function streamData() {
        const response = await fetch("http://127.0.0.1:7000/aicompletions", {
          method: "POST",
        });
        const reader = await response.body.getReader();
        while (await reader) {
          const { value, done } = await reader.read();
          if (done) {
            break;
          }
          const decoder = new TextDecoder("utf-8");
          const text = await decoder.decode(value);

          if (
            text.includes("data") &&
            !text.includes("usage") &&
            !text.includes("[DONE]") &&
            text.includes("choices")
          ) {
            const parts = text.split("\n");
            for(let i = 0;i<=parts.length-3;){
              let z = _.replace(parts[i], /data:/g, "");
              i = i+2
              outputDiv.innerHTML += JSON.parse(z).choices[0].delta.content;
            }
          }
        }
      }

      var connect = document.getElementById("connect");
      var send = document.getElementById("send");
      send.onclick = function () {
        streamData();
      };
    </script>
  </body>
</html>
